<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Juego de Reciclaje</title>
  <style>
    body{margin:0;font-family:system-ui,Segoe UI,Roboto,Arial,sans-serif;background:#ebf9e6;color:#0b3d1b}
    .game-wrap{padding:16px;max-width:900px;margin:auto}
    h2 { color: #0b3d1b; }

    .hud{display:flex;gap:10px;align-items:center;flex-wrap:wrap;margin-bottom:10px}
    .badge{background:#174d2d;border:1px solid #2a6b43;color:#d7e3ff;padding:.35rem .6rem;border-radius:10px}
    .accent{color:#50fa7b}
    .btn{appearance:none;border:1px solid #2a6b43;background:#174d2d;color:#d7e3ff;border-radius:10px;padding:.5rem .8rem;font-weight:600;cursor:pointer}
    .btn:hover{filter:brightness(1.1)}

    .playfield{display:grid;grid-template-columns:1fr;gap:16px}
    .items{min-height:140px;padding:12px;border:2px dashed #2a6b43;border-radius:14px;display:flex;flex-wrap:wrap;gap:10px;background:rgba(16,64,32,.35)}
    .item{
      user-select:none;padding:.45rem .6rem;border-radius:12px;border:1px solid #2a6b43;
      background:linear-gradient(180deg,#1c4a2d,#14371f);color:#e9f1ff;font-weight:700;letter-spacing:.2px;
      display:inline-flex;align-items:center;gap:.45rem; touch-action:none;
    }
    .item[draggable="true"]{cursor:grab}
    .item:active{cursor:grabbing}
    .item .icon{width:26px;height:26px;object-fit:contain;background:#ffffff14;border-radius:6px;padding:2px;display:inline-block}

    .bins{display:grid;grid-template-columns:repeat(5,1fr);gap:12px}
    @media (max-width: 720px){.bins{grid-template-columns:repeat(2,1fr)}}
    .bin{border:2px solid #2a6b43;border-radius:14px;padding:10px;min-height:120px;background:linear-gradient(180deg,#1c4a2d,#14371f);display:flex;flex-direction:column}
    .bin header{display:flex;align-items:center;gap:8px;margin-bottom:8px}
    .bin .drop{flex:1;min-height:90px}
    .bin .name{font-weight:800; color:#ffffff;}
    .bin .emoji img{width:24px;height:24px;object-fit:contain}
    .bin.accept{outline:3px dashed #7fa7ff;outline-offset:2px}
    .bin.correct{box-shadow:0 0 0 2px #50fa7b inset}
    .bin.wrong{box-shadow:0 0 0 2px #ff6978 inset}

    .legend{display:flex;gap:8px;flex-wrap:wrap;margin-top:10px}
    .legend span{border:1px solid #2a6b43;border-radius:999px;padding:.2rem .5rem;font-size:.75rem;background:rgba(93,255,134,.08);color:#0b3d1b;font-weight:600}

    /* Modal centrado para mensajes */
    .modal{
      position:fixed;inset:0;background:rgba(0,0,0,.6);display:flex;align-items:center;justify-content:center;
      visibility:hidden;opacity:0;transition:.3s;z-index:9999;
    }
    .modal.show{visibility:visible;opacity:1;}
    .modal-content{
      background:#fff;color:#0b3d1b;padding:20px 30px;border-radius:12px;
      text-align:center;max-width:420px;width:calc(100% - 40px);font-weight:600;box-shadow:0 6px 20px rgba(0,0,0,.3);
    }
    .modal-content button{
      margin-top:15px;padding:8px 16px;border:none;background:#174d2d;color:#fff;
      border-radius:8px;cursor:pointer;font-weight:600;
    }

    @media (max-width: 600px){
      h2 { font-size: 1.2rem; }
      .bin .name { font-size: 0.85rem; }
      .item { font-size: 0.8rem; padding: .3rem .5rem; }
      .item .icon { width:20px; height:20px; }
    }

    /* Fantasma para touch */
    .ghost{
      position:fixed; left:0; top:0; transform:translate(-9999px,-9999px);
      pointer-events:none; z-index:9998; opacity:.95;
    }

    /* Botón sonido */
    .sound-toggle{margin-left:auto}
    .muted{opacity:.65}
  </style>
</head>
<body>
  <div class="game-wrap">
    <h2>Juego: arrastra la basura al tacho correcto ♻️</h2>
    <div class="hud">
      <div class="badge">Puntaje: <span id="score" class="accent">0</span></div>
      <div class="badge">Intentos: <span id="attempts">0</span></div>
      <div class="badge">Restantes: <span id="remaining">0</span></div>
      <button class="btn sound-toggle" id="btn-sound" aria-pressed="true">🔊 Sonido: ON</button>
      <button class="btn" id="btn-new">Nuevo juego</button>
    </div>

    <div class="playfield">
      <div class="items" id="items"></div>
      <div class="bins" id="bins"></div>
    </div>

    <div class="legend"></div>
  </div>

  <!-- Modal -->
  <div class="modal" id="modal">
    <div class="modal-content">
      <p id="modal-msg"></p>
      <button onclick="closeModal()">Aceptar</button>
    </div>
  </div>

  <!-- Fantasma para touch -->
  <div id="ghost" class="ghost"></div>

  <script>
    /* ===== Sonidos (MP3 externos) con desbloqueo en primer toque ===== */
    const successAudio = new Audio("sounds/success.mp3");
    const errorAudio   = new Audio("sounds/error.mp3");
    let soundEnabled = true;
    let audioUnlocked = false;

    function unlockAudio(){
      if(audioUnlocked) return;
      // Intentos de reproducción silenciosa para desbloquear en iOS/Android
      try { successAudio.volume = 0.001; successAudio.play().then(()=>{ successAudio.pause(); successAudio.currentTime=0; audioUnlocked = true; }); } catch(e){}
      try { errorAudio.volume = 0.001; errorAudio.play().then(()=>{ errorAudio.pause(); errorAudio.currentTime=0; audioUnlocked = true; }); } catch(e){}
    }
    // Desbloquear al primer gesto del usuario
    window.addEventListener('pointerdown', unlockAudio, {once:true});
    window.addEventListener('keydown', unlockAudio, {once:true});

    function playSuccess(){ if(!soundEnabled) return; successAudio.currentTime=0; successAudio.volume=1; successAudio.play().catch(()=>{}); }
    function playError(){ if(!soundEnabled) return; errorAudio.currentTime=0; errorAudio.volume=1; errorAudio.play().catch(()=>{}); }

    /* ===== Datos del juego ===== */
    const CATEGORIES = [
      { key:'papel',   name:'Papel y Cartón', img:'img/tacho_papel.png'},
      { key:'plastico',name:'Plástico',       img:'img/tacho_plastico.png'},
      { key:'vidrio',  name:'Vidrio',         img:'img/tacho_vidrio.png'},
      { key:'metal',   name:'Metal',          img:'img/tacho_metal.png'},
      { key:'organico',name:'Orgánico',       img:'img/tacho_organico.png'}
    ];
    const TYPE_COLORS = {papel:'#7fb3ff', plastico:'#ffd166', vidrio:'#80e7c0', metal:'#bdb2ff', organico:'#95d67b'};
    const POOL = [
      {label:'Botella PET',      type:'plastico', src:'img/botella.jpg'},
      {label:'Revista',          type:'papel',    src:'img/revista.png'},
      {label:'Lata de gaseosa',  type:'metal',    src:'img/lata_gaseosa.png'},
      {label:'Frasco de vidrio', type:'vidrio',   src:'img/frasco_vidrio.png'},
      {label:'Cáscara de plátano', type:'organico', src:'img/platano.png'},
      {label:'Caja de cartón',   type:'papel',    src:'img/caja_carton.png'},
      {label:'Tapita plástica',  type:'plastico', src:'img/tapas.png'},
      {label:'Botella de vidrio',type:'vidrio',   src:'img/vidrio.png'},
      {label:'Restos de comida', type:'organico', src:'img/comida.png'},
      {label:'Envase de yogur',  type:'plastico', src:'img/yogur.png'}
    ];

    /* ===== Referencias UI ===== */
    const itemsEl = document.getElementById('items');
    const binsEl = document.getElementById('bins');
    const scoreEl = document.getElementById('score');
    const attemptsEl = document.getElementById('attempts');
    const remainingEl = document.getElementById('remaining');
    const btnNew = document.getElementById('btn-new');
    const btnSound = document.getElementById('btn-sound');
    const ghost = document.getElementById('ghost');

    let score=0, attempts=0, remaining=0;

    btnSound.addEventListener('click', ()=>{
      soundEnabled = !soundEnabled;
      btnSound.textContent = soundEnabled ? '🔊 Sonido: ON' : '🔇 Sonido: OFF';
      btnSound.classList.toggle('muted', !soundEnabled);
    });

    /* ===== Util ===== */
    function shuffle(arr){ return arr.sort(()=>Math.random()-.5); }
    function updateHUD(){ scoreEl.textContent=score; attemptsEl.textContent=attempts; remainingEl.textContent=remaining; }

    /* ===== Modal ===== */
    function showModal(msg){ document.getElementById("modal-msg").textContent = msg; document.getElementById("modal").classList.add("show"); }
    function closeModal(){ document.getElementById("modal").classList.remove("show"); }

    /* ===== Construcción ===== */
    function createBins(){
      binsEl.innerHTML='';
      CATEGORIES.forEach(cat=>{
        const bin=document.createElement('div');
        bin.className='bin';
        bin.dataset.accept=cat.key;
        bin.innerHTML=`<header><span class="emoji"><img src="${cat.img}" alt="${cat.name}"></span><span class="name">${cat.name}</span></header><div class="drop"></div>`;
        enableDrop(bin);
        binsEl.appendChild(bin);
      });
    }

    function createItems(){
      itemsEl.innerHTML='';
      const list=shuffle(POOL).slice(0,8);
      remaining=list.length; updateHUD();
      list.forEach(it=>{
        const el=document.createElement('div');
        el.className='item'; el.draggable=true; el.dataset.type=it.type;
        const img=it.src || svgIcon(it.label, TYPE_COLORS[it.type]||'#6aa9ff');
        el.innerHTML=`<img class="icon" src="${img}" alt="${it.label}"> <span>${it.label}</span>`;
        enableDrag(el); enableTouchDrag(el);
        itemsEl.appendChild(el);
      });
    }

    /* ===== Drag con mouse ===== */
    function enableDrag(el){
      el.addEventListener('dragstart', ()=> el.classList.add('dragging'));
      el.addEventListener('dragend',   ()=> el.classList.remove('dragging'));
    }

    /* ===== Drop común ===== */
    function enableDrop(bin){
      ['dragenter','dragover'].forEach(t=>{
        bin.addEventListener(t,e=>{e.preventDefault();bin.classList.add('accept');});
      });
      ['dragleave','drop'].forEach(t=>{
        bin.addEventListener(t,()=>bin.classList.remove('accept'));
      });
      bin.addEventListener('drop',e=>{
        e.preventDefault();
        const dragging=document.querySelector('.item.dragging'); if(!dragging) return;
        processDrop(dragging, bin);
      });
    }

    function processDrop(itemEl, bin){
      const ok = itemEl.dataset.type === bin.dataset.accept;
      attempts++;
      if(ok){
        score+=10; remaining--; bin.classList.add('correct'); itemEl.remove();
        playSuccess();
        setTimeout(()=>bin.classList.remove('correct'),500);
      }else{
        score=Math.max(0,score-3); bin.classList.add('wrong');
        playError();
        showModal("⚠️ Ese residuo no corresponde a este tacho. Intenta de nuevo.");
        setTimeout(()=>bin.classList.remove('wrong'),500);
        if(navigator.vibrate) navigator.vibrate(100); // vibración breve en móvil
      }
      updateHUD();
      if(remaining===0){ showModal(`🎉 ¡Buen trabajo! Puntaje final: ${score}`); }
    }

    /* ===== Drag en móviles (touch) ===== */
    let touchItem = null;
    function enableTouchDrag(el){
      el.addEventListener('touchstart', onTouchStart, {passive:false});
    }

    function onTouchStart(e){
      e.preventDefault();
      unlockAudio(); // asegúrate de que el audio quede habilitado tras primer toque
      touchItem = e.currentTarget;
      touchItem.classList.add('dragging');
      ghost.innerHTML = touchItem.innerHTML;
      ghost.style.transform = `translate(${e.touches[0].clientX}px, ${e.touches[0].clientY}px)`;
      ghost.style.display = 'inline-flex';
      ghost.classList.add('item');
      document.addEventListener('touchmove', onTouchMove, {passive:false});
      document.addEventListener('touchend', onTouchEnd, {passive:false});
    }

    function onTouchMove(e){
      e.preventDefault();
      const x = e.touches[0].clientX, y = e.touches[0].clientY;
      ghost.style.transform = `translate(${x}px, ${y}px)`;
      const el = document.elementFromPoint(x, y);
      document.querySelectorAll('.bin').forEach(b=>b.classList.remove('accept'));
      const bin = el && el.closest ? el.closest('.bin') : null;
      if(bin) bin.classList.add('accept');
    }

    function onTouchEnd(e){
      const x = e.changedTouches[0].clientX, y = e.changedTouches[0].clientY;
      const el = document.elementFromPoint(x, y);
      const bin = el && el.closest ? el.closest('.bin') : null;

      ghost.style.transform = 'translate(-9999px,-9999px)';
      ghost.classList.remove('item');
      document.querySelectorAll('.bin').forEach(b=>b.classList.remove('accept'));

      if(touchItem){
        touchItem.classList.remove('dragging');
        if(bin){ processDrop(touchItem, bin); }
      }
      touchItem = null;
      document.removeEventListener('touchmove', onTouchMove);
      document.removeEventListener('touchend', onTouchEnd);
    }

    /* ===== Utilidad: ícono fallback ===== */
    function svgIcon(text,bg){
      const s=`<svg xmlns='http://www.w3.org/2000/svg' width='64' height='64'>
        <rect rx='10' ry='10' width='64' height='64' fill='${bg}'/>
        <text x='50%' y='54%' dominant-baseline='middle' text-anchor='middle' font-size='28'
              font-family='Arial,Helvetica,sans-serif' fill='white'>${(text||'?').slice(0,2)}</text>
      </svg>`;
      return 'data:image/svg+xml;utf8,'+encodeURIComponent(s);
    }

    /* ===== Ciclo ===== */
    function newGame(){ score=0; attempts=0; remaining=0; updateHUD(); createItems(); }
    function init(){
      createBins(); newGame();
      btnNew.addEventListener('click', newGame);
      document.querySelector('.legend').innerHTML =
        CATEGORIES.map(c=>`<span><img src="${c.img}" alt="${c.name}" width="18"> ${c.name}</span>`).join('');
    }
    init();
  </script>
</body>
</html>
